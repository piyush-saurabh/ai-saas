This repo is created based on tutorial https://youtu.be/ffJ38dBzrlY

Original Repo:
https://github.com/AntonioErdeljac/next13-ai-saas

Use icons from here
https://lucide.dev/icons/

Install Prisma Extension for vscode
https://marketplace.visualstudio.com/items?itemName=Prisma.prisma


## Setup

Ref: https://ui.shadcn.com/docs/installation/next 

**Create the project**

```
npx create-next-app@latest ai-saas --typescript --tailwind --eslint 
```

**Setup the project**
```
npx shadcn-ui@latest init
```

**Packages**
```
# OpenAI
npm i openai

# Axios (for sending HTTP request from frontend)
npm i axios

# react-markdown (for displaying the markdown content, e.g code output) 
npm i react-markdown

# Replicate (for music generation)
npm i replicate

# Prisma (for tracking free tier limit)
npm i -D prisma

# Prisma Client
npm i @prisma/client

# Zustand (for showing the model to upgrade the plan)
npm i zustand

# Stripe (for payments)
npm i stripe

# For error message display
npm i react-hot-toast

# Crisp (for integrating chat support on the website)
npm i crisp-sdk-web

# For getting type writter effect on landing page
npm i typewriter-effect

```

**Run the project**

```
// Runs on locahost:3000
npm run dev
```

### Shadcn Components

**Button**
```
npx shadcn-ui@latest add button
```

**Sheet** (Menu for small/mobile screen)
```
npx shadcn-ui@latest add sheet
```

**Card** (for dashboard)
```
npx shadcn-ui@latest add card
```

**Form** (for conversation)
```
npx shadcn-ui@latest add form
```

**Input** (for form)
```
npx shadcn-ui@latest add input
```

**Avatar** (for user in conversation)
```
npx shadcn-ui@latest add avatar
```

**Select** (In image generation to select number of images)
```
npx shadcn-ui@latest add select
```

**Progress** (for showing the limit in free tier)
```
npx shadcn-ui@latest add progress
```

**Dialog** (for the upgrade modal)
```
npx shadcn-ui@latest add dialog
```

**Badge** (for the upgrade modal)
```
npx shadcn-ui@latest add badge
```

## Notes

* Shadcn UI is a CSS framework. All the components (e.g. button) installed using shadcn will be stored in /components folder.


### Folder Structure
* /app will contain all our routes
    * /app/globals.css: generated by shadcn ui
    * /app/page.tsx will be the default route /
    * /app/(dashboard)/layout.tsx contains the server component
    * /app/(dashboard)/(routes)/ contains the client component
* /components will have components from shadcn
* /lib/utils.ts will be used to merge tailwind classes
* /public: contains all the public assets on the websites like logo. They are accessed from the website using `/image.png`

## Routing
* /app/page.tsx will be the default route /
* /app/test/page.tsx will be located at /test
* We can use **Route Groups** to have a folder inside /app folder without having route on that. More details: https://nextjs.org/docs/app/building-your-application/routing/route-groups
    * add parenthesis around the folder to avoid effecting the route.

## Authentication

Provider: https://clerk.com/

**Setup**

Ref: https://clerk.com/docs/nextjs/get-started-with-nextjs

```
# Install Clerk
npm install @clerk/nextjs

# Import Clerk Provider in /app/layout.tsx
import { ClerkProvider } from '@clerk/nextjs'

```

Wrap entire application inside Clerk Provider
```
return (
    <ClerkProvider>
      <html lang="en">
      <body className={inter.className}>{children}</body>
    </html>
    </ClerkProvider>
    
  )
```

Create a file `middleware.ts` in application root and paste the content
```
import { authMiddleware } from "@clerk/nextjs";

// This example protects all routes including api/trpc routes
// Please edit this to allow other routes to be public as needed.
// See https://clerk.com/docs/nextjs/middleware for more information about configuring your middleware
export default authMiddleware({});

export const config = {
  matcher: ["/((?!.*\\..*|_next).*)", "/", "/(api|trpc)(.*)"],
};

```

Clerk nees to have the folder `sign-in/[[...sign-in]]` and `sign-up/[[...sign-up]]` for the authentication to work. We can name the folder to anything but but the folder should have same name.

By default all the routes will be protected. We have to explicitly add public route in `middleware.ts` file


## Database Setup

Initialize Prisma. It will create a new folder `prisma`
```
npx prisma init
```

**Setup Planetscale** (serverless MSQL database)
Go to https://planetscale.com/ > Create new database > Generate new password > Copy the connection string to .env > Copy the schema to /prisma/schema.prisma

Model for our table will be created in schema.prisma

**Model defination**
```
model userApiLimit {
  id String @id @default(cuid())
  userId String @unique
  count Int @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

Push the model to the database and add the models to the node modules (generate). This has to be done everytime we modify the model
```
# This will create a table
npx prisma db push

# This will add the models in node modules so that we can use them during development
npx prisma generate
```

View the data (http://localhost:5555/)
```
npx prisma studio
```

Remove everything from prisma (from CLI without using prisma studio)
```
npx prisma migrate reset
npx prisma generate
npx prisma db push
```

### Quering using prisma

**Create a prisma client**
File: lib/prismadb.ts
```
import { PrismaClient } from "@prisma/client";

declare global {
    var prisma: PrismaClient | undefined;
}

// Prevent multiple prisma client from getting created
const prismadb = globalThis.prisma || new PrismaClient();
if (process.env.NODE_ENV !== "production") globalThis.prisma = prismadb;

export default prismadb;
```

**Check if row exists (READ)**
```
// here 'userId' is a column
await prismadb.modelName.findUnique({
        where: {
            userId: userId
        }
    });
```

**Read a row and get selective (select) columns**
```
await prismadb.userSubscription.findUnique({
        where: {
            userId: userId
        },
        select:{
            stripeSubscriptionId: true,
            stripeCurrentPeriodEnd: true,
            stripeCustomerId: true,
            stripePriceId: true,
        },
    });
```

**Create a new record (CREATE)**
```
// here 'userId' and 'count' are columns of a table
// Note: Create does not require to provide values for all the columns. Other columns will be null
await prismadb.modelName.create({
            data: {userId: userId, count: 1}
        });
```

**Update an existing record (UPDATE)**
```
// here 'count' is a column
await prismadb.modelName.update({
            where: {userId: userId},
            data: { count: userApiLimit.count + 1 }
        });
```

## Payment Integration
Login to stripe dashboard: 
https://dashboard.stripe.com/dashboard

Copy the **Secret Key** from .env and set it to STRIPE_API_KEY 

For local development, download stripe CLI from: https://stripe.com/docs/stripe-cli

Setup for Ubuntu
```
# Add Stripe CLI’s GPG key to the apt sources keyring
curl -s https://packages.stripe.dev/api/security/keypair/stripe-cli-gpg/public | gpg --dearmor | sudo tee /usr/share/keyrings/stripe.gpg

# Add CLI’s apt repository to the apt sources list
echo "deb [signed-by=/usr/share/keyrings/stripe.gpg] https://packages.stripe.dev/stripe-cli-debian-local stable main" | sudo tee -a /etc/apt/sources.list.d/stripe.list

# Update package list
sudo apt update

# Install stripe CLI
sudo apt install stripe
```

**Login to Stripe using stripe CLI**
```
stripe login
```

**Send the stripe payment info to the local webhook**
```
stripe listen --forward-to localhost:3000/api/webhook

# If the above command get stuck at  "Getting ready...", run in debug mode
# stripe listen --forward-to localhost:3000/api/webhook --log-level=debug
# On ubuntu, change the /etc/resolv.conf and point the nameserver to 8.8.8.8
# Ref: https://github.com/stripe/stripe-cli/issues/359
```
Copy the 'webhook signing secret' received after running the above command to environment variable STRIPE_WEBHOOK_SECRET in .env

Go to https://dashboard.stripe.com/test/settings/billing/portal and click on "Activate Test Link"

Test data: https://stripe.com/docs/testing
Card Number: 4242 4242 4242 4242
Date: 12/34
CVV: any

## Customer support integration
Create an account on: https://crisp.chat/en/

Copy the CRISP_WEBSITE_ID
```
<script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="6bbc993d-4fee-46fb-bbff-1f65ea3978b6";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
```

## App Deployment
Go to `package.json` and add a post install script
```
"postinstall": "prisma generate"
```

Check for errors in the project
```
npm run lint
```

Follow the below steps to prepare for deployment:
* Create an account on vercel for deployment: https://vercel.com/
* Commit the code in github.
* Import the github repository to create the new vercel project.
* Add all the environment variables from local `.env` file. Copy all the content from `.env` and paste it in vercel.
* Click `Deploy`






